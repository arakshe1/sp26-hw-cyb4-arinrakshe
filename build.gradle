/*
 * This file was generated by the Gradle 'init' task.
 *
 * This generated file contains a sample Java application project to get you started.
 * For more details on building Java & JVM projects, please refer to https://docs.gradle.org/8.12.1/userguide/building_java_projects.html in the Gradle documentation.
 */

plugins {
    // Apply the application plugin to add support for building a CLI application in Java.
    id 'application'
    // Code formatting
    id 'com.diffplug.spotless' version '6.25.0'
    // Code linting
    id 'checkstyle'
    // Error Prone for static analysis
    id 'net.ltgt.errorprone' version '3.1.0'
    // Code coverage
    id 'jacoco'
}

repositories {
    mavenCentral()
    mavenLocal()
    maven {
        url 'https://central.sonatype.com/repository/maven-snapshots/'
    }
}

dependencies {
    // Use JUnit Jupiter (JUnit 5) test framework
    testImplementation libs.junit.jupiter.api
    testRuntimeOnly libs.junit.jupiter.engine
    testImplementation libs.junit.jupiter.params
    testImplementation libs.assertj.core

    // Mockito for mocking in tests
    testImplementation libs.mockito.core
    testImplementation libs.mockito.junit.jupiter

    // JSpecify for nullness annotations
    compileOnly libs.jspecify
    testCompileOnly libs.jspecify

    // Jackson for JSON serialization
    implementation libs.jackson.databind
    implementation libs.jackson.core
    implementation libs.jackson.annotations
    implementation libs.jackson.jdk8      // For Optional support
    implementation libs.jackson.jsr310    // For Java 8 date/time support

    // SLF4J and Logback for logging
    implementation libs.slf4j.api
    implementation libs.logback.classic
}

// Apply a specific Java toolchain to ease working on different environments.
java {
    toolchain {
        languageVersion = JavaLanguageVersion.of(21)
    }
}

tasks.named('test').configure {
    useJUnitJupiter()
    // Don't fail the build if tests fail
    ignoreFailures = true

    testLogging {
        events "failed"
        showStandardStreams = true  // Enable to see debug logs from logback
        exceptionFormat = "full"
        showExceptions = true
        showCauses = true
        showStackTraces = true
    }

    // Show counts of tests passed, failed, and skipped
    afterSuite { desc, result ->
        if (!desc.parent) {
            println "\nTests: ${result.testCount}, Passed: ${result.successfulTestCount}, Failed: ${result.failedTestCount}, Skipped: ${result.skippedTestCount}"
        }
    }
    finalizedBy jacocoTestReport
}


// JaCoCo configuration
jacoco {
    toolVersion = "0.8.11"
}

// Configure JaCoCo for test task - must be after jacoco block
tasks.withType(Test).configureEach {
    jacoco {
        enabled = true
    }
}

tasks.named('jacocoTestReport', JacocoReport).configure {
    // Don't fail if tests fail - generate report anyway
    mustRunAfter test
    /*
    reports {
        xml.required = true
        html.required = true
        csv.required = false
    }
    */

    // Explicitly set execution data location
    executionData.setFrom(fileTree(layout.buildDirectory.dir("jacoco")).include("*.exec"))
}

// Task to generate coverage report - using standard registration but lazy configuration
tasks.register('coverageReport', JacocoReport) {
    group = 'verification'
    description = 'Generates a code coverage report'
    dependsOn test

    /*
    reports {
        xml.required = true
        html.required = true
        html.outputLocation = layout.buildDirectory.dir('reports/jacoco/html')
    }
    */

    executionData test
    sourceSets sourceSets.main
}

// Spotless configuration for code formatting
spotless {
    java {
        // Remove unused imports first
        removeUnusedImports()

        // Use Google Java Format for code formatting
        // Note: googleJavaFormat will reorder imports, but we fix that below
        googleJavaFormat('1.23.0')

        // Configure import order AFTER formatter to override Google Java Format's import ordering
        // Order matches Checkstyle exactly: /^java\./, javax, org, com, net, app
        // Blank lines between groups (matches Checkstyle separated=true)
        // Static imports at top (matches Checkstyle option=top)
        // This MUST come after googleJavaFormat to fix import order
        importOrder('java', 'javax', '', 'org', '', 'com', '', 'net', '', 'app')

        // Trim trailing whitespace
        trimTrailingWhitespace()

        // End files with a newline
        endWithNewline()

        // Exclude generated files
        targetExclude(
            'build/**',
            '**/build/**',
            '**/generated/**'
        )
    }

    // Format other file types
    format 'misc', {
        target '*.gradle', '*.md', '.gitignore'
        trimTrailingWhitespace()
        indentWithSpaces(4)
        endWithNewline()
    }
}

// Checkstyle configuration for code linting
checkstyle {
    toolVersion = '10.17.0'
    configFile = file("${project.rootDir}/config/checkstyle/checkstyle.xml")
    ignoreFailures = false
    maxWarnings = 0
}

tasks.named('checkstyleMain').configure {
    // Ensure code is formatted before checking style
    dependsOn 'spotlessApply'
    reports {
        xml.required = false
        html.required = true
    }
}

tasks.named('checkstyleTest').configure {
    // Ensure code is formatted before checking style
    dependsOn 'spotlessApply'
    reports {
        xml.required = false
        html.required = true
    }
}

// Error Prone configuration
dependencies {
    errorprone 'com.google.errorprone:error_prone_core:2.30.0'
    errorprone 'com.uber.nullaway:nullaway:0.11.3'
    errorproneJavac 'com.google.errorprone:javac:9+181-r4173-1'
}

tasks.withType(JavaCompile).configureEach {
    options.encoding = 'UTF-8'

    // Enable Error Prone
    options.errorprone.enabled = true

    options.errorprone {
        // Disable specific checks if needed
        // disable('CheckName')
        disable('DoNotCallSuggester')  // Suppress warnings about methods that always throw exceptions

        // Enable additional checks (uncomment as needed)
        enable('NullAway')  // Requires separate NullAway dependency

        // Treat NullAway violations as errors
        error('NullAway')

        // Configure NullAway to use jspecify annotations
        option('NullAway:AnnotatedPackages', 'app.cookyourbooks')
        option('NullAway:JSpecifyMode', 'true')

        // Exclude generated files
        excludedPaths = '.*/build/generated/.*'
    }

    // Show all Error Prone warnings
    options.compilerArgs += [
        '-Xmaxwarns', '1000'
    ]
}

// Ensure errorProne runs as part of the build
compileJava {
    // This task will now automatically use errorprone due to the configuration above
    dependsOn 'spotlessApply'
}

compileTestJava {
    // Also run errorprone on test code
    dependsOn 'spotlessApply'
}
